worker_processes 1;
events { worker_connections 1024; }

# Whitelist environment variables
env JWT_SECRET;
env UPSTREAM_URL;
env CORS_ALLOW_ORIGIN;
env CORS_ALLOW_METHODS;
env CORS_ALLOW_HEADERS;
env CORS_ALLOW_CREDENTIALS;
env CORS_MAX_AGE;

http {
    include       mime.types;
    default_type  application/json;

    server {
        listen 80;
        set_by_lua $upstream_url 'return os.getenv("UPSTREAM_URL")';

        # CORS (defaults are permissive for Authorization header usage)
        set_by_lua $cors_allow_origin 'return os.getenv("CORS_ALLOW_ORIGIN") or "*"';
        set_by_lua $cors_allow_methods 'return os.getenv("CORS_ALLOW_METHODS") or "GET,POST,PUT,PATCH,DELETE,OPTIONS"';
        set_by_lua $cors_allow_headers 'return os.getenv("CORS_ALLOW_HEADERS") or "Authorization,Content-Type"';
        set_by_lua $cors_allow_credentials 'return os.getenv("CORS_ALLOW_CREDENTIALS") or "false"';
        set_by_lua $cors_max_age 'return os.getenv("CORS_MAX_AGE") or "86400"';

        # DNS resolver for proxy_pass. [fd12::10] is Railway's internal DNS resolver.
        resolver [fd12::10] valid=30s ipv6=on;
        resolver_timeout 2s;

        location / {
            # Preflight requests must not require Authorization
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $cors_allow_origin always;
                add_header Access-Control-Allow-Methods $cors_allow_methods always;
                add_header Access-Control-Allow-Headers $cors_allow_headers always;
                add_header Access-Control-Allow-Credentials $cors_allow_credentials always;
                add_header Access-Control-Max-Age $cors_max_age always;
                add_header Vary Origin always;
                return 204;
            }

            # Run our JWT verification script
            access_by_lua_file /usr/local/openresty/lua/auth.lua;

            # Proxy to your Railway private network address
            proxy_pass $upstream_url;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
