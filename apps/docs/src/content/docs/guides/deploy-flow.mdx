---
title: Deployment Flow
description: Complete guide to deploying decentralized websites using the Site Builder SDK deployment flow.
sidebar:
  order: 1
---

import { Tabs, TabItem, Steps } from '@astrojs/starlight/components';

The Site Builder SDK provides a comprehensive deployment flow that handles the entire process of deploying your website to Walrus + Sui networks. This guide walks you through each step of the deployment process, from asset preparation to live site deployment.

## Overview

The deployment flow consists of 4 sequential steps:

<Steps>

1. **Prepare Resources** - Encode and validate your files for deployment
2. **Write Resources** - Register and upload files to the Walrus decentralized storage network
3. **Certify Resources** - Create on-chain certificates for uploaded files on Sui
4. **Write Site** - Create or update your site with the certified resources

</Steps>

Each step must complete successfully before proceeding to the next step. The SDK provides event listeners and progress tracking to monitor the deployment process.

## Prerequisites

Before starting the deployment flow, ensure you have:

- ‚úÖ **Wallet Connected** - Sui wallet with sufficient funds for gas fees
- ‚úÖ **Files Prepared** - Your website files ready for deployment
- ‚úÖ **Network Access** - Connection to Walrus and Sui networks
- ‚úÖ **Gas Budget** - Sui tokens for blockchain transactions

## Basic Setup

### Initialize the SDK

```typescript
import { WalrusSiteBuilderSdk } from '@cmdoss/walrus-site-builder';
import { ZenFsFileManager } from '@cmdoss/file-manager';
import { useSuiClient, useCurrentAccount, useSignAndExecuteTransaction } from '@mysten/dapp-kit';
import { WalrusClient } from '@mysten/walrus';

function MyDeployComponent() {
  const suiClient = useSuiClient();
  const currentAccount = useCurrentAccount();
  const { mutateAsync: signAndExecuteTransaction } = useSignAndExecuteTransaction({
    execute: async ({ bytes, signature }) =>
      await suiClient.executeTransactionBlock({
        transactionBlock: bytes,
        signature,
        options: {
          showRawEffects: true,
          showObjectChanges: true
        }
      })
  });
  
  // Initialize Walrus client
  const walrusClient = new WalrusClient({
    aggregatorUrl: 'https://aggregator.walrus-testnet.walrus.space',
    publisherUrl: 'https://publisher.walrus-testnet.walrus.space'
  });
  
  // Initialize SDK
  const sdk = new WalrusSiteBuilderSdk(
    walrusClient,
    suiClient,
    currentAccount?.address ?? '',
    signAndExecuteTransaction
  );
}
```
```

### Create Deploy Flow

```typescript
import { ZenFsFileManager } from '@cmdoss/file-manager';

// Initialize file manager and add files
const fileManager = new ZenFsFileManager('/workspace');
await fileManager.initialize();

// Add your site files to the workspace
await fileManager.writeFile('/index.html', new TextEncoder().encode('<h1>Hello Walrus!</h1>'));
await fileManager.writeFile('/style.css', new TextEncoder().encode('body { color: blue; }'));

// Configure site resources
const wsResources: WSResources = {
  site_name: 'My Decentralized Website',
  metadata: {
    description: 'A website deployed on Walrus + Sui',
    creator: 'Your Name'
  },
  routes: [
    ['/*', '/index.html']  // SPA fallback route
  ]
};

// Create deploy flow instance
const deployFlow = sdk.executeSiteUpdateFlow(fileManager, wsResources);
```

## Step-by-Step Deployment

### Step 1: Prepare Resources

The first step encodes and validates your files for deployment:

```typescript
const handlePrepareResources = async () => {
  try {
    console.log('üöÄ Starting resource preparation...');
    
    await deployFlow.prepareResources();
    console.log('‚úÖ Resources prepared successfully');
    
    // Get transaction details
    const transactions = deployFlow.getTransactions();
    console.log('Transactions recorded:', transactions.length);
  } catch (error) {
    console.error('‚ùå Resource preparation failed:', error);
  }
};
```

**What happens during preparation:**
- Files are read from the file manager
- Files are encoded and validated for deployment compatibility
- Initial blob data is prepared for upload

### Step 2: Write Resources

Register and upload your prepared resources to the Walrus network with configurable storage options:

<Tabs syncKey="upload-options">
<TabItem label="Basic Upload">

```typescript
const handleWriteResources = async () => {
  try {
    console.log('üì§ Starting resource upload...');
    
    // Write for 1 epoch (non-permanent)
    await deployFlow.writeResources(1, false);
    
    console.log('‚úÖ Resources uploaded successfully');
  } catch (error) {
    console.error('‚ùå Resource upload failed:', error);
  }
};
```

</TabItem>
<TabItem label="Extended Storage">

```typescript
const handleWriteResources = async () => {
  try {
    console.log('üì§ Uploading resources for extended storage...');
    
    // Write for 5 epochs (approximately 5 days on testnet)
    await deployFlow.writeResources(5, false);
    
    console.log('‚úÖ Resources uploaded for 5 epochs');
  } catch (error) {
    console.error('‚ùå Upload failed:', error);
  }
};
```

</TabItem>
<TabItem label="Permanent Storage">

```typescript
const handleWriteResources = async () => {
  try {
    console.log('üì§ Uploading resources for permanent storage...');
    
    // Write with maximum epochs and permanent flag
    await deployFlow.writeResources('max', true);
    
    console.log('‚úÖ Resources uploaded permanently');
  } catch (error) {
    console.error('‚ùå Upload failed:', error);
  }
};
```

</TabItem>
</Tabs>

**Write Parameters:**
- **epochs**: Storage duration (`number` or `'max'`)
  - `1-100`: Specific number of epochs
  - `'max'`: Maximum available epochs (57 on mainnet)
- **permanent**: Whether files should be stored permanently (`boolean`)

**Storage Cost Calculation:**
```typescript
// Calculate storage cost before upload
const totalSize = await fileManager.getSize();
const costPerEpoch = Math.ceil(totalSize / 1000); // Approximate cost in MIST
const totalCost = costPerEpoch * epochs;

console.log(`Estimated cost: ${totalCost} MIST for ${epochs} epochs`);
```

### Step 3: Certify Resources

Certify your uploaded resources on the Sui blockchain for immutable proof:

```typescript
const handleCertifyResources = async () => {
  try {
    console.log('üîê Starting resource certification...');
    
    const { certifiedBlobs } = await deployFlow.certifyResources();
    
    console.log('‚úÖ Resources certified successfully');
    console.log(`Certified ${certifiedBlobs.length} blobs`);
    
    // Process certified blobs
    certifiedBlobs.forEach(blob => {
      console.log({
        file: blob.identifier,
        blobId: blob.blobId,
        suiObjectId: blob.suiObjectId,
        patchId: blob.patchId
      });
    });
    
  } catch (error) {
    console.error('‚ùå Resource certification failed:', error);
  }
};
```

**Certification provides:**
- üîê **On-chain proof** of file existence and integrity
- üîó **Immutable references** that cannot be tampered with
- üåê **Sui integration** for decentralized verification
- üìù **Audit trail** of all deployment transactions

### Step 4: Write Site

Create or update your site with the certified resources:

```typescript
import { objectIdToWalrusSiteUrl } from '@cmdoss/walrus-site-builder';

const handleWriteSite = async () => {
  try {
    console.log('üåê Creating/updating site...');
    
    const { siteId } = await deployFlow.writeSite();
    
    if (siteId) {
      console.log('‚úÖ Site deployed successfully');
      console.log('Site Object ID:', siteId);
      
      // Generate site URL for different portals
      const siteUrls = {
        localhost: objectIdToWalrusSiteUrl(siteId, 'localhost:3000', false),
        testnet: objectIdToWalrusSiteUrl(siteId, 'walrus-testnet.walrus.space', true),
        mainnet: objectIdToWalrusSiteUrl(siteId, 'walrus.space', true)
      };
      
      console.log('Site URLs:', siteUrls);
      
      // Open site in new tab
      window.open(siteUrls.localhost, '_blank');
    }
  } catch (error) {
    console.error('‚ùå Site update failed:', error);
  }
};
```

## Complete React Implementation

Here's a complete React component implementing the deployment flow:

```typescript
import { useState } from 'react';
import { WalrusSiteBuilderSdk, type ICertifiedBlob } from '@cmdoss/walrus-site-builder';
import { ZenFsFileManager } from '@cmdoss/file-manager';
import { useSuiClient, useCurrentAccount, useSignAndExecuteTransaction } from '@mysten/dapp-kit';
import { WalrusClient } from '@mysten/walrus';

enum DeploySteps {
  Idle,
  Prepared,
  Written, 
  Certified,
  Deployed
}

function DeploymentComponent() {
  const [currentStep, setCurrentStep] = useState(DeploySteps.Idle);
  const [loading, setLoading] = useState(false);
  const [deployedSiteId, setDeployedSiteId] = useState<string | null>(null);
  const [certifiedBlobs, setCertifiedBlobs] = useState<ICertifiedBlob[]>([]);
  const [fileManager] = useState(() => new ZenFsFileManager('/workspace'));
  const [deployFlow, setDeployFlow] = useState<ReturnType<typeof sdk.executeSiteUpdateFlow> | null>(null);
  
  const suiClient = useSuiClient();
  const currentAccount = useCurrentAccount();
  const { mutateAsync: signAndExecuteTransaction } = useSignAndExecuteTransaction({
    execute: async ({ bytes, signature }) =>
      await suiClient.executeTransactionBlock({
        transactionBlock: bytes,
        signature,
        options: {
          showRawEffects: true,
          showObjectChanges: true
        }
      })
  });
  
  const walrusClient = new WalrusClient({
    aggregatorUrl: 'https://aggregator.walrus-testnet.walrus.space',
    publisherUrl: 'https://publisher.walrus-testnet.walrus.space'
  });
  
  const sdk = new WalrusSiteBuilderSdk(
    walrusClient,
    suiClient,
    currentAccount?.address ?? '',
    signAndExecuteTransaction
  );
  
  const wsResources = {
    site_name: 'My Decentralized Website',
    metadata: {
      description: 'Deployed with CommandOSS SDKs',
      creator: 'Your Name'
    },
    routes: [['/*', '/index.html']] as [string, string][]
  };
  
  const handlePrepareResources = async () => {
    setLoading(true);
    try {
      await fileManager.initialize();
      const flow = sdk.executeSiteUpdateFlow(fileManager, wsResources);
      setDeployFlow(flow);
      await flow.prepareResources();
      setCurrentStep(DeploySteps.Prepared);
    } catch (error) {
      console.error('Preparation failed:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const handleWriteResources = async (epochs: number) => {
    setLoading(true);
    try {
      await deployFlow?.writeResources(epochs, false);
      setCurrentStep(DeploySteps.Written);
    } catch (error) {
      console.error('Write failed:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const handleCertifyResources = async () => {
    setLoading(true);
    try {
      const result = await deployFlow?.certifyResources();
      if (result) {
        setCertifiedBlobs(result.certifiedBlobs);
      }
      setCurrentStep(DeploySteps.Certified);
    } catch (error) {
      console.error('Certification failed:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const handleWriteSite = async () => {
    setLoading(true);
    try {
      const result = await deployFlow?.writeSite();
      if (result) {
        setDeployedSiteId(result.siteId);
      }
      setCurrentStep(DeploySteps.Deployed);
    } catch (error) {
      console.error('Site update failed:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="deployment-flow">
      <h2>Deploy Your Website</h2>
      
      <div className="deploy-steps">
        <button 
          onClick={handlePrepareResources}
          disabled={currentStep !== DeploySteps.Idle || loading}
          className={currentStep > DeploySteps.Idle ? 'completed' : ''}
        >
          {currentStep > DeploySteps.Idle ? '‚úÖ Prepared' : '1. Prepare Resources'}
        </button>
        
        <button 
          onClick={() => handleWriteResources(5)}
          disabled={currentStep !== DeploySteps.Prepared || loading}
          className={currentStep > DeploySteps.Prepared ? 'completed' : ''}
        >
          {currentStep > DeploySteps.Prepared ? '‚úÖ Written' : '2. Write Resources'}
        </button>
        
        <button 
          onClick={handleCertifyResources}
          disabled={currentStep !== DeploySteps.Written || loading}
          className={currentStep > DeploySteps.Written ? 'completed' : ''}
        >
          {currentStep > DeploySteps.Written ? '‚úÖ Certified' : '3. Certify Resources'}
        </button>
        
        <button 
          onClick={handleWriteSite}
          disabled={currentStep !== DeploySteps.Certified || loading}
          className={currentStep > DeploySteps.Certified ? 'completed' : ''}
        >
          {currentStep > DeploySteps.Certified ? '‚úÖ Deployed' : '4. Write Site'}
        </button>
      </div>
      
      {loading && <div className="loading">Processing...</div>}
      
      {deployedSiteId && (
        <div className="deployment-success">
          <h3>üéâ Deployment Successful!</h3>
          <p><strong>Site ID:</strong> {deployedSiteId}</p>
          <a 
            href={objectIdToWalrusSiteUrl(deployedSiteId, 'localhost:3000', false)}
            target="_blank"
            rel="noopener noreferrer"
          >
            Visit Your Site ‚Üí
          </a>
        </div>
      )}
    </div>
  );
}
```

## Error Handling & Best Practices

### Common Error Scenarios

```typescript
const deployWithErrorHandling = async () => {
  try {
    await deployFlow.prepareResources();
  } catch (error) {
    if (error.message.includes('insufficient funds')) {
      console.error('‚ùå Insufficient funds for gas fees');
      // Show user-friendly message to add funds
    } else if (error.message.includes('network')) {
      console.error('‚ùå Network connection issue');
      // Retry logic or network switching
    } else {
      console.error('‚ùå Preparation failed:', error);
    }
  }
};
```

### Best Practices

1. **Always check wallet connection** before starting deployment
2. **Initialize file manager** before calling `prepareResources()`
3. **Handle network errors** gracefully with retry logic
4. **Show progress indicators** to users during long operations
5. **Store deployment results** for future reference
6. **Test on testnet** before mainnet deployment

## Next Steps

- **[File Management Guide](/guides/file-management/)** - Learn to manage files in the browser
- **[Cost Calculation](/guides/cost-calculation/)** - Understand storage costs
- **[Examples](/examples/)** - See complete working examples
- **[API Reference](/reference/)** - Detailed API documentation